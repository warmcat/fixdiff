# fixdiff

Copyright (C) 2025 Andy Green <andy@warmcat.com>
Licensed under MIT license, see LICENSE

```
$ cat llm-patch.diff | fixdiff | patch -p1
```

or with redirect

```
$ cat llm-patch.diff | fixdiff > llm-patch-fixed.diff
```

or optionally if run from elsewhere, you can tell it a path to change CWD to
on the commandline so it can find the sources mentioned in the patch.

```
$ cat llm-patch.diff | fixdiff /path/to/sources | patch -p1
```

`fixdiff` is designed to clean up diffs generated by LLMs (eg, Gemini 2.5).

LLM find it hard to generate diff headers with correct line counts or even
line offsets, although some LLMs are smart enough to produce otherwise
legible diffs.  Often the content or just the context lines around the
changes are not quite right.

This utility adjusts the diff stanzas sent to it on stdin and produces new stanza
headers with accurate line counts on stdout.

It silently repairs:

 1. New empty + lines with only whitespace are rewritten to be empty blank lines
 2. Diff stanzas that do not contain any +/- lines are removed
 3. Original lines in diff that differ from real line in file only by
    whitespace are rewritten to contain the correct whitespace
 4. All stanza header line offsets and counts are recomputed from the actual
    match in the original source and counting before and after lines in the diff,
    the incoming @@ line is completely ignored and rewritten with actual info
 5. Extra lead-in context lines to stanza by removing until only 3
 6. Excessive lead-out-context is removed, missing lead-out context is added.
    Diffs adding to EOF with missing or wrong context caused by
    LLM losing blank lines at the original EOF are rewritten by checking
    the original source file for extra lines and adding them as needed.
 7. Unexpected blank lines in a stanza (without space, + or -) are either ignored
    if happening at the end of the stanza, or rewritten to be context by adding
    a space at the beginning, if the normal diff resumes.

It finds and scans the sources the patches apply to and uses the diff stanza to
find the original line it applied to by itself, along with the original line
count and, considering earlier stanzas, the line in the modified file it appears
at and the new line count for the stanza.  Thus, it does not use the incoming
broken stanza header information at all and replaces all the @@ lines with
correct numbers according to the changed and unchanged sources, and the actual
diff contents inside the stanza.

It handles diffs starting with --- as produced by most LLMs, also those with
diff and index headers, and supports any combination of concatenated diffs
targeting different files in one step.

## Building

 - There are no dependencies other than libc.
 - It's pure C99.
 - It's valgrind-clean.
 - It just produces a small executable with no data files.
 - There are no switches.
 - It runs as part of a pipe into patch or standalone with redirects.

You can build it like:

```
$ mkdir build
$ cd build
$ cmake ..
$ make && sudo make install
```

Selftests can be run after build with `ctest --output-on-failure`.

